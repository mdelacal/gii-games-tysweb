<!doctype html>
<html lang="en">
<script
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<script src="angular/Game.js"></script>

<head>
<title>Sudoku</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!--===============================================================================================-->
<link rel="icon" type="image/png" href="images/icons/favicon.ico" />
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="vendor/bootstrap/css/bootstrap.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="fonts/Linearicons-Free-v1.0.0/icon-font.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="vendor/css-hamburgers/hamburgers.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="vendor/select2/select2.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css" href="css/util.css">
<link rel="stylesheet" type="text/css" href="css/main.css">
<!--===============================================================================================-->
<style type="text/css">
html, body {
	background-color: #FAFAFA
}

table {
	border: 2px solid #000000;
}

td {
	border: 1px solid #000000;
	text-align: center;
	vertical-align: middle;
}
/*
    input {
        color: #000000;
        padding: 0;
        border: 0;
        text-align: center;
        width: 48px;
        height: 48px;
        font-size: 24px;
        background-color: #FFFFFF;
        outline: none;
    }*/
input:disabled {
	background-color: #EEEEEE;
}

#cellPropio-0, #cellPropio-1, #cellPropio-2, #cellPropio-3, #cellPropio-4, #cellPropio-5, #cellPropio-6, #cellPropio-7, #cellPropio-8,#cellPropio-27, #cellPropio-28, #cellPropio-29,
#cellPropio-30, #cellPropio-31, #cellPropio-32,  #cellPropio-33, #cellPropio-34, #cellPropio-35, #cellPropio-54, #cellPropio-55, #cellPropio-56, #cellPropio-57, #cellPropio-58, #cellPropio-59,
#cellPropio-60, #cellPropio-61, #cellPropio-62{
	border-top: 2px solid #000000;
}

#cellPropio-2, #cellPropio-11, #cellPropio-20, #cellPropio-5, #cellPropio-14, #cellPropio-23, #cellPropio-8, #cellPropio-17, #cellPropio-26, #cellPropio-29, #cellPropio-38, #cellPropio-47,
#cellPropio-32, #cellPropio-41, #cellPropio-50, #cellPropio-35, #cellPropio-44, #cellPropio-53, #cellPropio-56, #cellPropio-65, #cellPropio-74, #cellPropio-59, #cellPropio-68, #cellPropio-77,
#cellPropio-62, #cellPropio-71, #cellPropio-80{
	border-right: 2px solid #000000;
}

#cellPropio-18, #cellPropio-19, #cellPropio-20, #cellPropio-21, #cellPropio-22, #cellPropio-23, #cellPropio-24, #cellPropio-25, #cellPropio-26, #cellPropio-45, #cellPropio-46, #cellPropio-47, 
#cellPropio-48, #cellPropio-49, #cellPropio-50, #cellPropio-51, #cellPropio-52, #cellPropio-53, #cellPropio-72, #cellPropio-73, #cellPropio-74, #cellPropio-75, #cellPropio-76, #cellPropio-77,
#cellPropio-78, #cellPropio-79, #cellPropio-80{
	border-bottom: 2px solid #000000;
}

#cellPropio-0, #cellPropio-9, #cellPropio-18, #cellPropio-3, #cellPropio-12, #cellPropio-21, #cellPropio-6, #cellPropio-15, #cellPropio-24, #cellPropio-27, #cellPropio-36, #cellPropio-45,
#cellPropio-30, #cellPropio-39, #cellPropio-48, #cellPropio-33, #cellPropio-42, #cellPropio-51, #cellPropio-54, #cellPropio-63, #cellPropio-72, #cellPropio-57, #cellPropio-66, #cellPropio-75,
#cellPropio-60, #cellPropio-69, #cellPropio-78{
	border-left: 2px solid #000000;
}

#cellRival-0, #cellRival-1, #cellRival-2, #cellRival-3, #cellRival-4, #cellRival-5, #cellRival-6, #cellRival-7, #cellRival-8,#cellRival-27, #cellRival-28, #cellRival-29,
#cellRival-30, #cellRival-31, #cellRival-32,  #cellRival-33, #cellRival-34, #cellRival-35, #cellRival-54, #cellRival-55, #cellRival-56, #cellRival-57, #cellRival-58, #cellRival-59,
#cellRival-60, #cellRival-61, #cellRival-62{
	border-top: 2px solid #000000;
}

#cellRival-2, #cellRival-11, #cellRival-20, #cellRival-5, #cellRival-14, #cellRival-23, #cellRival-8, #cellRival-17, #cellRival-26, #cellRival-29, #cellRival-38, #cellRival-47,
#cellRival-32, #cellRival-41, #cellRival-50, #cellRival-35, #cellRival-44, #cellRival-53, #cellRival-56, #cellRival-65, #cellRival-74, #cellRival-59, #cellRival-68, #cellRival-77,
#cellRival-62, #cellRival-71, #cellRival-80{
	border-right: 2px solid #000000;
}

#cellRival-18, #cellRival-19, #cellRival-20, #cellRival-21, #cellRival-22, #cellRival-23, #cellRival-24, #cellRival-25, #cellRival-26, #cellRival-45, #cellRival-46, #cellRival-47, 
#cellRival-48, #cellRival-49, #cellRival-50, #cellRival-51, #cellRival-52, #cellRival-53, #cellRival-72, #cellRival-73, #cellRival-74, #cellRival-75, #cellRival-76, #cellRival-77,
#cellRival-78, #cellRival-79, #cellRival-80{
	border-bottom: 2px solid #000000;
}

#cellRival-0, #cellRival-9, #cellRival-18, #cellRival-3, #cellRival-12, #cellRival-21, #cellRival-6, #cellRival-15, #cellRival-24, #cellRival-27, #cellRival-36, #cellRival-45,
#cellRival-30, #cellRival-39, #cellRival-48, #cellRival-33, #cellRival-42, #cellRival-51, #cellRival-54, #cellRival-63, #cellRival-72, #cellRival-57, #cellRival-66, #cellRival-75,
#cellRival-60, #cellRival-69, #cellRival-78{
	border-left: 2px solid #000000;
}

</style>
</head>

<body onload="conectarWS()">
	<div class="limiter">
		<div class="container-login100">
			<div class="wrap-login100 w1260 p-l-25 p-r-25 p-t-30 p-b-10 col-lg-8">
				<span class="login100-form-title p-b-25"> Partida de Sudokus
				</span>
				<div class="row p-b-30">
					<div class=" col-lg-6" style="padding-left: 2.2rem;">
						<div>
							<div class="contenedor p-t-8 p-b-14">
								<div>
									<span class="glyphicon glyphicon-comment"></span>Completa el
									sudoku
								</div>
							</div>
						</div>
						<div>
							<div class="contenedor p-t-8 p-b-14">
								<div id="sudokuPropio">
								Resuelve este sudoku:
								</div>
								<div id="sudokuRival">
								Sudoku Rival
								</div>
							</div>
						</div>
						<div id="textosRecibidos" class="p-t-16 p-b-22"
							style="text-align: center"></div>
					</div>
					<div class="col-lg-6">
						<div class="contenedor">
							<div class="card card-primary">
								<div class="card-header">
									<span class="glyphicon glyphicon-comment"></span>Chat de
									jugadores
								</div>
								<div class="card-body" style="overflow-y: auto; height: 350px;"
									id="chatjugadores">
									<ul class="chat">
									</ul>
								</div>
								<div class="card-footer">
									<div class="input-group">
										<input id="msg" type="text" class="form-control input-sm"
											placeholder="Escribir..." /> <span class="input-group-btn">
											<button class="btn" id="btnEnviar" onclick="enviarMensaje()"
												style="color: #ffffff; background-color: #0250c5; border-color: #0250c5;">Enviar</button>
										</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="dropDownSelect1"></div>
	<li style="display: none" id="chatDeJugadores" class="left clearfix">
		<div class="chat-body clearfix">
			<div class="header">
				<strong class="primary-font usuarioChat"></strong>
			</div>
			<p class="mensajeChat"></p>
		</div>
	</li>
	<!--===============================================================================================-->
	<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/bootstrap/js/popper.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/select2/select2.min.js"></script>
	<!--===============================================================================================-->
	<script src="js/main.js"></script>
	<script>
    var ws = {};
	function generar_sudoku_propio(){
		var body = document.getElementById('sudokuPropio');
		
		var tabla = document.createElement("table");
		var tb1Body = document.createElement("tbody");
		
		for(var i=0;i<9;i++){
			var hilera = document.createElement("tr");
			for (var j=0;j<9;j++){
				var celda = document.createElement("td");
				var lista = document.createElement('select');
				for(var k=0;k<10;k++){
					var op=new Option(""+k,""+k);
					lista.appendChild(op);
				}
				var id=i*9+j;
				lista.setAttribute("id","cellPropio-"+id);
				lista.setAttribute("onchange","move("+id+")")
				celda.appendChild(lista);
				hilera.appendChild(celda);
			}
			tb1Body.appendChild(hilera);
		}
		tabla.appendChild(tb1Body);
		body.appendChild(tabla);
		
	}
	function generar_sudoku_rival(){
		var body = document.getElementById('sudokuRival');
		
		var tabla = document.createElement("table");
		var tb1Body = document.createElement("tbody");
		
		for(var i=0;i<9;i++){
			var hilera = document.createElement("tr");
			for (var j=0;j<9;j++){
				var celda = document.createElement("td");
				var lista = document.createElement('select');
				var op=new Option("","");
				var id=i*9+j;
				lista.setAttribute("id","cellRival-"+id);
				lista.setAttribute("disabled",true);
				celda.appendChild(lista);
				hilera.appendChild(celda);
			}
			tb1Body.appendChild(hilera);
		}
		tabla.appendChild(tb1Body);
		body.appendChild(tabla);
		
	}
    //unirse a una partida
    function joinGame(gameName) {
        var request = new XMLHttpRequest();
        request.open("GET", "http://localhost:8080/joinGame?gameName=" + gameName);
        request.onreadystatechange = function() {
            if (request.readyState == 4) {

            }
        };
        request.send();
    }

    //agrega info sobre la partida
    function add(texto) {
        var div = document.createElement("div");
        textosRecibidos.appendChild(div);
        div.innerHTML = texto;
    }

    //envia un mensaje por el chat de jugadores
    function enviarMensaje() {
        if (document.getElementById("msg").value != "") {
            var p = {
                TYPE: "MENSAJE",
                player: sessionStorage.getItem('userName'),
                mensaje: document.getElementById("msg").value,
            };
            ws.send(JSON.stringify(p));
            document.getElementById("msg").value = "";
        }
    }

    //cambiar el numero de una casilla del sudoku
    function move(coordinate) {
        var p = {
            TYPE: "SUDOKU",
            player: sessionStorage.getItem('userName'),
            coordinate: [coordinate,document.getElementById("cellPropio-"+coordinate).value],
        };
        ws.send(JSON.stringify(p));
    }
    
    //muestra el sudoku inicial en el html
    function sudokuinicialhtml(sudoku){
    	var i;
    	for(i=0; i<81; i++){
    		if(sudoku[i]!=0){
    			var celda = "cellPropio-" + i;
    			var celdaRival="cellRival-"+i;
    			document.getElementById(celda).selectedIndex = sudoku[i];
    			document.getElementById(celda).disabled = true;
    			var element=document.getElementById(celdaRival);
    			element.style.backgroundColor="#000000";
			}
		}
    }
    
    //comprueba si el cambio en la celda es correcto, mostrando un background rojo/verde y desactiva el elemento
    function comprobarCelda(celda, valor, tablerofinal){
    	var cell = "cellPropio-" + celda;
		var element = document.getElementById(cell);
    	if(tablerofinal[celda]==valor){	
			element.style.backgroundColor = "#ccffcc";
			document.getElementById(cell).disabled = true;
    	}else{
    		element.style.backgroundColor = "#ffccd1";
    	}
    }
    function notificarMovimiento(celda, valor,tablerofinal){
    	var cell= "cellRival-"+celda;
    	var element = document.getElementById(cell);
    	if(tablerofinal[celda]==valor){
    		element.style.backgroundColor = "#fce63f";
    	}
    }
    //conexion con el WS y gestion de mensajes recibidos
    function conectarWS() {
        if (window.WebSocket == undefined) {
            alert("Lo sentimos, pero tu navegador no soporta este tipo de comunicaciÃ³n");
            return;
        }

        var url = "ws://localhost:8080/gamews";
        ws = new WebSocket(url);

        ws.onmessage = function(datos) {
            var mensaje = datos.data;
            mensaje = JSON.parse(mensaje);
            //si se recibe un mensaje de chat
            if (mensaje.TYPE == "MENSAJE") {
                var jugador = mensaje.player;
                var mensajeEnviado = mensaje.mensaje;

                $("#chatDeJugadores").clone().appendTo(".chat");
                $('.chat #chatDeJugadores').show(10);
                $('.chat #chatDeJugadores .usuarioChat').html(jugador);
                $('.chat #chatDeJugadores .mensajeChat').html(mensajeEnviado);
                $('.chat #chatDeJugadores').attr("id", "");

                var chatjugadores = document.getElementById("chatjugadores");
                chatjugadores.scrollTop = chatjugadores.scrollHeight;

            //si se recibe un mensaje de la partida de sudoku 
            } else if (mensaje.TYPE == "MATCH") {
                if(mensaje.players.length=="1"){
    				add(mensaje.players[0].userName + " se ha unido a la partida");	
    				add("Esperando rival...");
    			}
                if(mensaje.players.length=="2"){
                	add(mensaje.players[1].userName + " se ha unido a la partida");
    				add("COMIENZA LA PARTIDA!!");
					add(mensaje.players[0].userName + " VS " + mensaje.players[1].userName);
					
					if(mensaje.players[0].userName == sessionStorage.getItem("userName"))
						sudokuinicialhtml(mensaje.board.tableroinicial0);
					else
						sudokuinicialhtml(mensaje.board.tableroinicial1);
                }
            //si se ha hecho un movimiento en el sudoku
            } else if (mensaje.TYPE == "MOVIMIENTOSUDOKU") {
            	//si todavia no hay ganador comprobamos la celda
            	if (mensaje.winner==null){
            		if(mensaje.current_player == sessionStorage.getItem("userName")){
            			comprobarCelda(mensaje.celda, mensaje.valor, mensaje.board.tablerofinal);
            		}
            		else{
            			notificarMovimiento(mensaje.celda,mensaje.valor,mensaje.board.tablerofinal);
            		}
            		
            	}
            	//si hay ganador final de la partida
            	else if (mensaje.winner!=null){
    				//hacemos la comprobacion de la ultima celda en el ganador
            		if(mensaje.winner.userName == sessionStorage.getItem("userName"))
    					comprobarCelda(mensaje.celda, mensaje.valor, mensaje.board.tablerofinal);
            		//notificamos a los players del final de la partida
    				add("-------------------")
    				add("FIN DE LA PARTIDA!!");
    				add("Ganador: " + mensaje.winner.userName);
    				//regresamos al menu principal
					alert("La partida ha terminado. Se volverá al menú principal.");
					window.location.href = "menu.html";
    			}  	
            }
        }
    }

    //si se ha iniciado sesion se unira a una partida de SUDOKU
    if (sessionStorage.getItem('userName') != null) {
    	generar_sudoku_propio();
    	generar_sudoku_rival();
        joinGame('Sudoku');
    }
    </script>
</body>

</html>

