<!doctype html>
<html lang="en">
<script
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<script src="angular/Game.js"></script>

<head>
<title>Sudoku</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!--===============================================================================================-->
<link rel="icon" type="image/png" href="images/icons/favicon.ico" />
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="vendor/bootstrap/css/bootstrap.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="fonts/Linearicons-Free-v1.0.0/icon-font.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="vendor/css-hamburgers/hamburgers.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css"
	href="vendor/select2/select2.min.css">
<!--===============================================================================================-->
<link rel="stylesheet" type="text/css" href="css/util.css">
<link rel="stylesheet" type="text/css" href="css/main.css">
<!--===============================================================================================-->
<style type="text/css">
html, body {
	background-color: #FAFAFA
}

table {
	border: 2px solid #000000;
}

td {
	border: 1px solid #000000;
	text-align: center;
	vertical-align: middle;
}
/*
    input {
        color: #000000;
        padding: 0;
        border: 0;
        text-align: center;
        width: 48px;
        height: 48px;
        font-size: 24px;
        background-color: #FFFFFF;
        outline: none;
    }*/
input:disabled {
	background-color: #EEEEEE;
}

#cell-0, #cell-1, #cell-2, #cell-3, #cell-4, #cell-5, #cell-6, #cell-7, #cell-8,#cell-27, #cell-28, #cell-29,
#cell-30, #cell-31, #cell-32,  #cell-33, #cell-34, #cell-35, #cell-54, #cell-55, #cell-56, #cell-57, #cell-58, #cell-59,
#cell-60, #cell-61, #cell-62{
	border-top: 2px solid #000000;
}

#cell-2, #cell-11, #cell-20, #cell-5, #cell-14, #cell-23, #cell-8, #cell-17, #cell-26, #cell-29, #cell-38, #cell-47,
#cell-32, #cell-41, #cell-50, #cell-35, #cell-44, #cell-53, #cell-56, #cell-65, #cell-74, #cell-59, #cell-68, #cell-77,
#cell-62, #cell-71, #cell-80{
	border-right: 2px solid #000000;
}

#cell-18, #cell-19, #cell-20, #cell-21, #cell-22, #cell-23, #cell-24, #cell-25, #cell-26, #cell-45, #cell-46, #cell-47 
#cell-48, #cell-49, #cell-50, #cell-51, #cell-52, #cell-53, #cell-72, #cell-73, #cell-74, #cell-75, #cell-76, #cell-77,
#cell-78, #cell-79, #cell-80{
	border-bottom: 2px solid #000000;
}

#cell-0, #cell-9, #cell-18, #cell-3, #cell-12, #cell-21, #cell-6, #cell-15, #cell-24, #cell-27, #cell-36, #cell-45
#cell-30, #cell-39, #cell-48, #cell-33, #cell-42, #cell-51, #cell-54, #cell-63, #cell-72, #cell-57, #cell-66, #cell-75,
#cell-60, #cell-69, #cell-78{
	border-left: 2px solid #000000;
}

</style>
</head>

<body onload="conectarWS()">
	<div class="limiter">
		<div class="container-login100">
			<div class="wrap-login100 w1260 p-l-25 p-r-25 p-t-30 p-b-10 col-lg-8">
				<span class="login100-form-title p-b-25"> Partida de Sudokus
				</span>
				<div class="row p-b-30">
					<div class=" col-lg-6" style="padding-left: 2.2rem;">
						<div>
							<div class="contenedor p-t-8 p-b-14">
								<div>
									<span class="glyphicon glyphicon-comment"></span>Completa el
									sudoku
								</div>
							</div>
						</div>
						<div>
							<div class="contenedor p-t-8 p-b-14">
								<div id="parteSudoku">
								</div>
							</div>
						</div>
						<div id="textosRecibidos" class="p-t-16 p-b-22"
							style="text-align: center"></div>
					</div>
					<div class="col-lg-6">
						<div class="contenedor">
							<div class="card card-primary">
								<div class="card-header">
									<span class="glyphicon glyphicon-comment"></span>Chat de
									jugadores
								</div>
								<div class="card-body" style="overflow-y: auto; height: 350px;"
									id="chatjugadores">
									<ul class="chat">
									</ul>
								</div>
								<div class="card-footer">
									<div class="input-group">
										<input id="msg" type="text" class="form-control input-sm"
											placeholder="Escribir..." /> <span class="input-group-btn">
											<button class="btn" id="btnEnviar" onclick="enviarMensaje()"
												style="color: #ffffff; background-color: #0250c5; border-color: #0250c5;">Enviar</button>
										</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="dropDownSelect1"></div>
	<li style="display: none" id="chatDeJugadores" class="left clearfix">
		<div class="chat-body clearfix">
			<div class="header">
				<strong class="primary-font usuarioChat"></strong>
			</div>
			<p class="mensajeChat"></p>
		</div>
	</li>
	<!--===============================================================================================-->
	<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/bootstrap/js/popper.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
	<!--===============================================================================================-->
	<script src="vendor/select2/select2.min.js"></script>
	<!--===============================================================================================-->
	<script src="js/main.js"></script>
	<script>
    var ws = {};
	function generar_sudoku(){
		var body = document.getElementById('parteSudoku');
		
		var tabla = document.createElement("table");
		var tb1Body = document.createElement("tbody");
		
		for(var i=0;i<9;i++){
			var hilera = document.createElement("tr");
			for (var j=0;j<9;j++){
				var celda = document.createElement("td");
				var lista = document.createElement('select');
				for(var k=0;k<10;k++){
					var op=new Option(""+k,""+k);
					lista.appendChild(op);
				}
				var id=i*9+j;
				lista.setAttribute("id","cell-"+id);
				lista.setAttribute("onchange","move("+id+")")
				celda.appendChild(lista);
				hilera.appendChild(celda);
			}
			tb1Body.appendChild(hilera);
		}
		tabla.appendChild(tb1Body);
		body.appendChild(tabla);
		
	}
    //unirse a una partida
    function joinGame(gameName) {
        var request = new XMLHttpRequest();
        request.open("GET", "http://localhost:8080/joinGame?gameName=" + gameName);
        request.onreadystatechange = function() {
            if (request.readyState == 4) {

            }
        };
        request.send();
    }

    //agrega info sobre la partida
    function add(texto) {
        var div = document.createElement("div");
        textosRecibidos.appendChild(div);
        div.innerHTML = texto;
    }

    //envia un mensaje por el chat de jugadores
    function enviarMensaje() {
        if (document.getElementById("msg").value != "") {
            var p = {
                TYPE: "MENSAJE",
                player: sessionStorage.getItem('userName'),
                mensaje: document.getElementById("msg").value,
            };
            ws.send(JSON.stringify(p));
            document.getElementById("msg").value = "";
        }
    }

    //cambiar el numero de una casilla del sudoku
    function move(coordinate) {
        var p = {
            TYPE: "SUDOKU",
            player: sessionStorage.getItem('userName'),
            coordinate: [coordinate],
            value: document.getElementById("cell-" + coordinate).value
        };
        ws.send(JSON.stringify(p));
    }
    
    //muestra el sudoku inicial en el html
    function sudokuinicialhtml(sudoku){
    	var i;
    	for(i=0; i<81; i++){
    		if(sudoku[i]!=0){
    			var celda = "cell-" + i;
    			document.getElementById(celda).selectedIndex = sudoku[i];
    			document.getElementById(celda).disabled = true;
			}
		}
    }
    
    //comprueba si el cambio en la celda es correcto, mostrando un background rojo/verde y desactiva el elemento
    function comprobarCelda(celda, valor, tablerofinal){
    	var cell = "cell-" + celda;
		var element = document.getElementById(cell);
    	if(tablerofinal[celda]==valor){	
			element.style.backgroundColor = "#ccffcc";
			document.getElementById(cell).disabled = true;
    	}else{
    		element.style.backgroundColor = "#ffccd1";
    	}
    }

    //conexion con el WS y gestion de mensajes recibidos
    function conectarWS() {
        if (window.WebSocket == undefined) {
            alert("Lo sentimos, pero tu navegador no soporta este tipo de comunicacion");
            return;
        }

        var url = "ws://localhost:8080/gamews";
        ws = new WebSocket(url);

        ws.onmessage = function(datos) {
            var mensaje = datos.data;
            mensaje = JSON.parse(mensaje);
            //si se recibe un mensaje de chat
            if (mensaje.TYPE == "MENSAJE") {
                var jugador = mensaje.player;
                var mensajeEnviado = mensaje.mensaje;

                $("#chatDeJugadores").clone().appendTo(".chat");
                $('.chat #chatDeJugadores').show(10);
                $('.chat #chatDeJugadores .usuarioChat').html(jugador);
                $('.chat #chatDeJugadores .mensajeChat').html(mensajeEnviado);
                $('.chat #chatDeJugadores').attr("id", "");

                var chatjugadores = document.getElementById("chatjugadores");
                chatjugadores.scrollTop = chatjugadores.scrollHeight;

            //si se recibe un mensaje de la partida de sudoku 
            } else if (mensaje.TYPE == "MATCH") {
                if(mensaje.players.length=="1"){
    				add(mensaje.players[0].userName + " se ha unido a la partida");	
    				add("Esperando rival...");
    			}
                if(mensaje.players.length=="2"){
                	add(mensaje.players[1].userName + " se ha unido a la partida");
    				add("COMIENZA LA PARTIDA!!");
					add(mensaje.players[0].userName + " VS " + mensaje.players[1].userName);
					
					if(mensaje.players[0].userName == sessionStorage.getItem("userName"))
						sudokuinicialhtml(mensaje.board.tableroinicial0);
					else
						sudokuinicialhtml(mensaje.board.tableroinicial1);
                }
                
            //si se ha hecho un movimiento en el sudoku
            } else if (mensaje.TYPE == "MOVIMIENTOSUDOKU") {
            	//si todavia no hay ganador comprobamos la celda
            	if (mensaje.winner==null){
            		comprobarCelda(mensaje.celda, mensaje.valor, mensaje.board.tablerofinal);
            	}
            	//si hay ganador final de la partida
            	else if (mensaje.winner!=null){
    				//hacemos la comprobacion de la ultima celda en el ganador
            		if(mensaje.winner.userName == sessionStorage.getItem("userName"))
    					comprobarCelda(mensaje.celda, mensaje.valor, mensaje.board.tablerofinal);
            		
    				//notificamos a los players del final de la partida
    				add("-------------------")
    				add("FIN DE LA PARTIDA!!");
    				add("Ganador: " + mensaje.winner.userName);
    				
    				//regresamos al menu principal
    				alert("La partida ha terminado. Se volverá al menú principal.");
    				window.location.href = "menu.html";
    			}  	
            }
        }
    }

    //si se ha iniciado sesion se unira a una partida de SUDOKU
    if (sessionStorage.getItem('userName') != null) {
    	generar_sudoku();
        joinGame('Sudoku');
    }
    </script>
</body>

</html>